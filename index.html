<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <title>Bali Trip 2025 - JAPA Edition</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    
    <!-- FontAwesome -->
    <link rel="manifest" href="manifest.json" />
    <meta name="theme-color" content="#4A6C6F">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #FdfcF8; /* Sand color */
            -webkit-tap-highlight-color: transparent;
        }
        
        /* Hide Scrollbar but keep functionality */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* Glassmorphism */
        .glass {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.03);
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.6);
        }

        .weather-widget {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
        }

        /* Animations */
        .fade-enter-active, .fade-leave-active {
            transition: opacity 0.3s ease;
        }
        .fade-enter-from, .fade-leave-to {
            opacity: 0;
        }

        .slide-up-enter-active, .slide-up-leave-active {
            transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }
        .slide-up-enter-from, .slide-up-leave-to {
            transform: translateY(100%);
        }
    </style>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        bali: {
                            green: '#4A6C6F',
                            sand: '#FdfcF8',
                            sunset: '#FF9F76',
                            ocean: '#84B4C8',
                            text: '#2D3748',
                            dark: '#1A202C'
                        }
                    }
                }
            }
        }
    </script>
    <script>
    // 強制移除舊版 Service Worker
    if ("serviceWorker" in navigator) {
    navigator.serviceWorker.getRegistrations().then((registrations) => {
        registrations.forEach((reg) => {
        reg.unregister();
        });
    });
    }
    </script>
</head>
<body class="text-slate-800 antialiased h-screen overflow-hidden selection:bg-bali-green selection:text-white">

    <div id="app" class="h-full flex flex-col relative">

        <!-- Top Navigation / Header -->
        <header class="glass fixed top-0 w-full z-30 px-5 pt-safe-top pb-2 transition-all duration-300 flex flex-col gap-3">
            
            <!-- Top Row: Title & Weather/Current Status -->
            <div class="flex justify-between items-start pt-4">
                <div>
                    <h2 class="text-[10px] font-bold text-bali-sunset tracking-widest uppercase mb-0.5">Dec 10 - Dec 17</h2>
                    <h1 class="text-xl font-bold text-bali-green leading-tight">{{ getPageTitle }}</h1>
                    <div class="flex items-center gap-2 mt-1 text-xs text-slate-500">
                        <i class="fa-solid fa-location-dot"></i> JAPA Suites & Villas
                    </div>
                </div>

                <!-- Weather & Current Event Widget -->
                <div class="flex flex-col items-end gap-2">
                    <!-- Weather -->
                    <div class="flex items-center gap-1.5 bg-blue-50/80 px-2 py-1 rounded-lg border border-blue-100">
                        <i class="fa-solid fa-cloud-sun text-yellow-500 text-sm"></i>
                        <span class="text-xs font-bold text-slate-600">28°C</span>
                    </div>
                    
                    <!-- Current Event Badge -->
                    <div v-if="currentTab === 'itinerary'" class="text-right">
                        <div class="text-[10px] text-slate-400 font-medium mb-0.5">NEXT UP</div>
                        <div class="bg-bali-green text-white text-[10px] px-2.5 py-1 rounded-md shadow-sm font-medium truncate max-w-[120px]">
                            {{ nextEvent ? nextEvent.title : '享受愜意時光' }}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Date Selector (Only visible on Itinerary tab) -->
            <div v-if="currentTab === 'itinerary'" class="w-full overflow-x-auto no-scrollbar pb-2 pt-1" id="date-scroller">
                <div class="flex sm:justify-between gap-3 min-w-max px-1">
                    <button 
                        v-for="(day, index) in days" 
                        :key="index"
                        @click="activeDayIndex = index"
                        :class="[
                            'flex-shrink-0 flex flex-col items-center justify-center w-[4.2rem] h-16 rounded-2xl transition-all duration-300 border relative overflow-hidden',
                            activeDayIndex === index 
                                ? 'bg-bali-green text-white border-bali-green shadow-lg scale-105 z-10' 
                                : 'bg-white/80 text-slate-400 border-transparent shadow-sm hover:bg-white'
                        ]"
                    >
                        <span class="text-[9px] font-bold uppercase tracking-wider opacity-80">Day {{ index + 1 }}</span>
                        <span class="text-lg font-bold leading-none mt-0.5">{{ day.date.split('/')[1] }}</span>
                        <span class="text-[9px] font-medium opacity-60 mt-0.5">{{ day.weekday }}</span>
                    </button>
                </div>
            </div>
        </header>

        <!-- Main Content Area -->
        <!-- <main class="flex-1 overflow-y-auto no-scrollbar pb-32 pt-56 bg-bali-sand scroll-smooth" id="main-scroll"> -->
        <main id="main-scroll"
                :class="['flex-1 overflow-y-auto no-scrollbar bg-bali-sand scroll-smooth',
                currentTab === 'map' ? 'pt-56 pb-0' : 'pt-56 pb-32'
            ]">

            <!-- VIEW: ITINERARY -->
            <div v-if="currentTab === 'itinerary'" class="px-5 space-y-6">
                
                <div v-if="currentDayEvents.length === 0" class="text-center py-20 opacity-50">
                    <i class="fa-solid fa-umbrella-beach text-4xl mb-4 text-bali-ocean"></i>
                    <p>這天還沒有行程<br>去探索頁面加點什麼吧！</p>
                </div>

                <div 
                    v-for="(event, index) in sortedEvents" 
                    :key="event.id" 
                    :id="'event-' + event.id"
                    class="relative pl-6 border-l-2 border-slate-200/60 pb-8 last:pb-0 group"
                >
                    <!-- Timeline Dot -->
                    <div class="absolute -left-[9px] top-0 w-4 h-4 rounded-full bg-white border-4 border-bali-ocean ring-4 ring-bali-sand z-10"></div>
                    
                    <!-- Card -->
                    <div class="glass-card p-4 rounded-2xl shadow-sm hover:shadow-md transition-all active:scale-[0.99] relative overflow-hidden">
                        <!-- Edit/Delete Actions -->
                        <div class="absolute top-3 right-3 flex gap-2">
                            <button @click="editEvent(event)" class="text-slate-300 hover:text-bali-green p-1 transition-colors">
                                <i class="fa-solid fa-pen-to-square text-sm"></i>
                            </button>
                            <button @click="deleteEvent(event.id)" class="text-slate-300 hover:text-red-400 p-1 transition-colors">
                                <i class="fa-solid fa-trash text-sm"></i>
                            </button>
                        </div>

                        <div class="flex items-start gap-4">
                            <div class="text-bali-green font-bold text-lg w-14 leading-tight pt-0.5 font-mono">
                                {{ event.time }}
                            </div>
                            <div class="flex-1 pr-6">
                                <h3 class="font-bold text-slate-800 text-lg leading-tight mb-1">{{ event.title }}</h3>
                                <div class="flex items-center text-slate-500 text-xs gap-1.5 mb-2 uppercase tracking-wide font-medium">
                                    <i :class="getCategoryIcon(event.category)"></i>
                                    <span>{{ getCategoryName(event.category) }}</span>
                                </div>
                                <p v-if="event.note" class="text-slate-500 text-sm italic mb-3 bg-slate-50/50 p-2 rounded-lg border border-slate-100">{{ event.note }}</p>
                                <!-- 新增：行程圖片（選填） -->
                                <div v-if="event.image" class="rounded-xl overflow-hidden mb-3 h-28">
                                    <img :src="event.image" alt="" class="w-full h-full object-cover">
                                </div>

    
                                <!-- Location Button -->
                                <a :href="getGoogleMapsUrl(event.location)" target="_blank" class="inline-flex items-center gap-2 bg-slate-100/80 hover:bg-blue-50 text-slate-600 px-3 py-2 rounded-lg text-xs font-semibold transition-colors w-full sm:w-auto justify-center sm:justify-start border border-slate-200">
                                    <i class="fa-solid fa-location-dot text-bali-sunset"></i>
                                    {{ event.location }}
                                    <i class="fa-solid fa-arrow-up-right-from-square text-[10px] ml-auto sm:ml-1 opacity-50"></i>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Add Button -->
                <button @click="openAddModal" class="w-full py-4 border-2 border-dashed border-slate-300 rounded-2xl text-slate-400 font-medium hover:border-bali-green hover:text-bali-green hover:bg-bali-green/5 transition-all mt-6 flex items-center justify-center gap-2">
                    <i class="fa-solid fa-plus"></i> 新增行程
                </button>
            </div>

            <!-- VIEW: EXPLORE / SAVED -->
            <div v-else-if="currentTab === 'explore'" class="px-5">
                
                <div class="bg-bali-green/10 rounded-xl p-4 mb-6 flex items-start gap-3">
                    <i class="fa-solid fa-map-location-dot text-bali-green text-xl mt-1"></i>
                    <div>
                        <h3 class="font-bold text-bali-green text-sm">JAPA 周邊推薦</h3>
                        <p class="text-xs text-slate-600 mt-1">以下精選距離您住宿 JAPA Suites & Villas 步行或短程車程內的優質地點。</p>
                    </div>
                </div>

                <!-- Category Filter -->
                <div class="flex gap-2 overflow-x-auto no-scrollbar mb-6 -mx-5 px-5 pt-2">
                    <button 
                        v-for="cat in categories" 
                        :key="cat.id"
                        @click="activeCategory = cat.id"
                        :class="[
                            'px-4 py-2 rounded-full text-sm font-medium whitespace-nowrap transition-colors border',
                            activeCategory === cat.id 
                                ? 'bg-bali-green text-white border-bali-green shadow-md' 
                                : 'bg-white text-slate-500 border-slate-100 shadow-sm'
                        ]"
                    >
                        {{ cat.name }}
                    </button>
                </div>

                <div class="grid grid-cols-1 gap-4">
                    <div v-for="spot in filteredSpots" :key="spot.id" class="bg-white rounded-2xl p-0 shadow-sm overflow-hidden flex flex-row h-32 relative group border border-slate-100">
                        <div class="w-32 bg-slate-200 bg-cover bg-center shrink-0" :style="{ backgroundImage: 'url(' + spot.image + ')' }"></div>
                        <div class="p-3 flex flex-col justify-between flex-1">
                            <div>
                                <div class="flex justify-between items-start">
                                    <h3 class="font-bold text-slate-800 leading-tight">{{ spot.name }}</h3>
                                    <div class="flex gap-1 text-xs text-yellow-400 bg-yellow-50 px-1.5 py-0.5 rounded-md">
                                        <i class="fa-solid fa-star"></i>
                                        <span class="text-slate-600 font-bold">{{ spot.rating }}</span>
                                    </div>
                                </div>
                                <div class="flex items-center gap-1 mt-1 text-[10px] text-slate-400">
                                    <i class="fa-solid fa-person-walking"></i>
                                    <span>{{ spot.distance }}</span>
                                </div>
                                <p class="text-xs text-slate-500 mt-1 line-clamp-2">{{ spot.desc }}</p>
                            </div>
                            <div class="flex justify-between items-end">
                                <span class="text-[10px] px-2 py-1 bg-slate-100 rounded-md text-slate-500 font-medium">{{ spot.area }}</span>
                                
                                <div class="flex gap-2">
                                    <!-- New Google Map Icon Link -->
                                    <a :href="getGoogleMapsUrl(spot.mapsUrl || spot.name)" target="_blank" class="bg-white text-slate-400 border border-slate-200 w-8 h-8 rounded-full shadow-sm active:scale-95 transition-transform flex items-center justify-center hover:text-bali-ocean hover:border-bali-ocean">
                                        <i class="fa-solid fa-map-location-dot text-xs"></i>
                                    </a>

                                    <!-- Add to Itinerary Button -->
                                    <button @click="openAddToDayModal(spot)" class="bg-bali-ocean text-white w-8 h-8 rounded-full shadow-lg active:scale-95 transition-transform flex items-center justify-center hover:bg-bali-green">
                                        <i class="fa-solid fa-plus text-xs"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Add Custom Spot Button -->
                <button @click="openAddSpotModal" class="w-full py-4 border-2 border-dashed border-slate-300 rounded-2xl text-slate-400 font-medium hover:border-bali-green hover:text-bali-green hover:bg-bali-green/5 transition-all mt-4 mb-4 flex items-center justify-center gap-2">
                    <i class="fa-solid fa-plus"></i> 新增探索地點
                </button>
            </div>

            <!-- VIEW: FOOTPRINT MAP (Simulated) -->
            <!-- VIEW: FOOTPRINT MAP (Google My Maps) -->
            <div v-else-if="currentTab === 'map'" class="px-0 h-full flex flex-col">
                <!-- 上面的說明列，不需要 sticky，只要正常貼在 map 上方 -->
                <div class="bg-bali-sand/95 backdrop-blur px-5 py-3 mb-2 border-b border-slate-100">
                    <p class="text-sm text-slate-500 flex items-center gap-2">
                        <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
                        顯示整體旅程地圖（Google My Maps）
                    </p>
                </div>

                <!-- 這塊會吃掉 map view 剩下所有高度 -->
                <div class="flex-1 mt-0">
                    <iframe
                        src="https://www.google.com/maps/d/embed?mid=16Wj1a1x_1wIqio6fdctKRFKuOGM9b20&ehbc=2E312F"
                        class="w-full h-full border-0"
                        loading="lazy"
                        referrerpolicy="no-referrer-when-downgrade"
                    ></iframe>
                </div>
            </div>




        </main>

        <!-- Bottom Navigation -->
        <nav class="fixed bottom-0 w-full bg-white/95 backdrop-blur-xl border-t border-slate-200 pb-safe pt-2 px-6 pb-6 z-40 flex justify-between items-center shadow-[0_-5px_30px_rgba(0,0,0,0.03)]">
            <button 
                v-for="tab in tabs" 
                :key="tab.id"
                @click="currentTab = tab.id"
                :class="[
                    'flex flex-col items-center gap-1 w-16 transition-colors',
                    currentTab === tab.id ? 'text-bali-green' : 'text-slate-300 hover:text-slate-400'
                ]"
            >
                <div :class="['text-xl transition-transform duration-300', currentTab === tab.id ? '-translate-y-1 drop-shadow-md' : '']">
                    <i :class="tab.icon"></i>
                </div>
                <span class="text-[10px] font-bold tracking-wide">{{ tab.label }}</span>
            </button>
        </nav>

        <!-- MODAL: Add/Edit Event -->
        <transition name="slide-up">
            <div v-if="showModal" class="fixed inset-0 z-50 flex items-end justify-center sm:items-center">
                <div class="absolute inset-0 bg-black/30 backdrop-blur-sm" @click="closeModal"></div>
                <div class="bg-white w-full sm:w-[400px] sm:rounded-2xl rounded-t-3xl p-6 shadow-2xl relative z-50 max-h-[90vh] overflow-y-auto">
                    
                    <div class="w-12 h-1.5 bg-slate-200 rounded-full mx-auto mb-6"></div>
                    
                    <h3 class="text-xl font-bold text-slate-800 mb-6">{{ isEditing ? '編輯行程' : '新增行程' }}</h3>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">標題</label>
                            <input v-model="form.title" type="text" class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 focus:outline-none focus:border-bali-green focus:ring-1 focus:ring-bali-green transition-all" placeholder="例如：Morning Yoga">
                        </div>

                        <div class="flex gap-4">
                             <div class="w-1/3">
                                <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">時間</label>
                                <input v-model="form.time" type="time" class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 focus:outline-none focus:border-bali-green">
                            </div>
                            <div class="w-2/3">
                                <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">分類</label>
                                <select v-model="form.category" class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 focus:outline-none focus:border-bali-green">
                                    <option value="sightseeing">觀光</option>
                                    <option value="food">美食</option>
                                    <option value="cafe">咖啡</option>
                                    <option value="yoga">瑜珈</option>
                                    <option value="massage">按摩</option>
                                    <option value="transport">交通</option>
                                </select>
                            </div>
                        </div>

                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">地點 (Google Maps 搜尋)</label>
                            <div class="relative">
                                <i class="fa-solid fa-map-pin absolute left-4 top-3.5 text-slate-400"></i>
                                <input v-model="form.location" type="text" class="w-full bg-slate-50 border border-slate-200 rounded-xl pl-10 pr-4 py-3 focus:outline-none focus:border-bali-green" placeholder="例如：Ubud Market">
                            </div>
                        </div>

                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">備註</label>
                            <textarea v-model="form.note" rows="2" class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 focus:outline-none focus:border-bali-green" placeholder="記得帶防蚊液..."></textarea>
                        </div>
                        <!-- 新增：圖片 URL -->
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">圖片 URL（選填）</label>
                            <input
                                v-model="form.image"
                                type="url"
                                class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 focus:outline-none focus:border-bali-green"
                                placeholder="貼上你想要的行程照片網址，例如 Unsplash 圖片"
                            >
                        </div>
                    </div>

                    <div class="flex gap-3 mt-8">
                        <button @click="closeModal" class="flex-1 py-3.5 rounded-xl font-bold text-slate-500 bg-slate-100 hover:bg-slate-200 transition-colors">取消</button>
                        <button @click="saveEvent" class="flex-1 py-3.5 rounded-xl font-bold text-white bg-bali-green shadow-lg shadow-bali-green/30 hover:bg-opacity-90 transition-colors">儲存</button>
                    </div>
                </div>
            </div>
        </transition>

        <!-- MODAL: Add Custom Spot -->
        <transition name="slide-up">
            <div v-if="showAddSpotModal" class="fixed inset-0 z-50 flex items-end justify-center sm:items-center">
                <div class="absolute inset-0 bg-black/30 backdrop-blur-sm" @click="showAddSpotModal = false"></div>
                <div class="bg-white w-full sm:w-[400px] sm:rounded-2xl rounded-t-3xl p-6 shadow-2xl relative z-50">
                    
                    <div class="w-12 h-1.5 bg-slate-200 rounded-full mx-auto mb-6"></div>
                    <h3 class="text-xl font-bold text-slate-800 mb-6">新增探索地點</h3>

                    <div class="space-y-4">
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">地點名稱</label>
                            <input v-model="spotForm.name" type="text" class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 focus:outline-none focus:border-bali-green" placeholder="例如：好吃咖啡店">
                        </div>
                        
                        <div class="flex gap-4">
                             <div class="w-1/2">
                                <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">分類</label>
                                <select v-model="spotForm.category" class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 focus:outline-none focus:border-bali-green">
                                    <option value="food">美食</option>
                                    <option value="cafe">咖啡</option>
                                    <option value="yoga">瑜珈</option>
                                    <option value="massage">按摩</option>
                                    <option value="sightseeing">觀光</option>
                                </select>
                            </div>
                            <div class="w-1/2">
                                <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">區域</label>
                                <input v-model="spotForm.area" type="text" class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 focus:outline-none focus:border-bali-green" placeholder="例如：Ubud">
                            </div>
                        </div>

                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">簡短描述</label>
                            <textarea v-model="spotForm.desc" rows="2" class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 focus:outline-none focus:border-bali-green" placeholder="推薦理由..."></textarea>
                        </div>
                    </div>
                
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">
                            圖片 URL（選填）
                        </label>
                        <input 
                            v-model="spotForm.image" 
                            type="url"
                            class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 
                                focus:outline-none focus:border-bali-green"
                            placeholder="例如：貼一張 Unsplash 或店家照片連結"
                        >
                    </div>

                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">
                            Google Maps 連結（選填）
                        </label>
                        <input 
                            v-model="spotForm.mapsUrl" 
                            type="url"
                            class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 
                                focus:outline-none focus:border-bali-green"
                            placeholder="可貼完整的 Google Maps 分享網址，不填則用名稱搜尋"
                        >
                    </div>
                    <div class="flex gap-3 mt-8">
                        <button @click="showAddSpotModal = false" class="flex-1 py-3.5 rounded-xl font-bold text-slate-500 bg-slate-100 hover:bg-slate-200">取消</button>
                        <button @click="saveNewSpot" class="flex-1 py-3.5 rounded-xl font-bold text-white bg-bali-green shadow-lg shadow-bali-green/30 hover:bg-opacity-90">新增</button>
                    </div>
                </div>
            </div>
        </transition>

        <!-- MODAL: Add from Explore -->
        <transition name="slide-up">
            <div v-if="showAddToDayModal" class="fixed inset-0 z-50 flex items-end justify-center sm:items-center">
                <div class="absolute inset-0 bg-black/30 backdrop-blur-sm" @click="showAddToDayModal = false"></div>
                    <div class="bg-white w-full sm:w-[400px] sm:rounded-2xl rounded-t-3xl p-6 shadow-2xl relative z-50">
                        
                        <div class="text-center mb-6">
                            <h3 class="text-xl font-bold text-slate-800">加入 "{{ selectedSpot?.name }}" 到...</h3>
                            <p class="text-sm text-slate-500 mt-1">先選一天，再設定時間</p>
                        </div>

                        <!-- Day selector -->
                        <div class="grid grid-cols-4 gap-2 mb-4">
                            <button 
                                v-for="(day, idx) in days" 
                                :key="idx"
                                @click="addToDayDayIndex = idx"
                                :class="[
                                    'flex flex-col items-center justify-center p-2 rounded-xl border transition-colors',
                                    addToDayDayIndex === idx 
                                        ? 'border-bali-green bg-green-50 text-bali-green' 
                                        : 'border-slate-200 hover:border-bali-green hover:bg-green-50 text-slate-600'
                                ]"
                            >
                                <span class="text-[10px] font-bold text-slate-400 uppercase">Day {{ idx+1 }}</span>
                                <span class="text-lg font-bold text-bali-green">{{ day.date.split('/')[1] }}</span>
                            </button>
                        </div>

                        <!-- Time selector -->
                        <div class="mb-6">
                            <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">
                                時間
                            </label>
                            <input
                                v-model="addToDayTime"
                                type="time"
                                class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 
                                    focus:outline-none focus:border-bali-green"
                            >
                        </div>

                        <!-- Action buttons -->
                        <div class="flex gap-3">
                            <button 
                                @click="showAddToDayModal = false" 
                                class="flex-1 py-3 rounded-xl font-bold text-slate-500 bg-slate-100 hover:bg-slate-200"
                            >
                                取消
                            </button>
                            <button 
                                @click="confirmAddToDay" 
                                class="flex-1 py-3 rounded-xl font-bold text-white bg-bali-green hover:bg-opacity-90 shadow-lg shadow-bali-green/30"
                            >
                                加入行程
                            </button>
                        </div>
                    </div>
            </div>
        </transition>

    </div>
    <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
    import {
        getFirestore,
        collection,
        doc,
        addDoc,
        updateDoc,
        deleteDoc,
        onSnapshot,
        serverTimestamp
    } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDfYdRmvWx3Z9dZowIRTh9GFZ3n6CVnEf0",
        authDomain: "bali-10be3.firebaseapp.com",
        projectId: "bali-10be3",
        storageBucket: "bali-10be3.firebasestorage.app",
        messagingSenderId: "28298868900",
        appId: "1:28298868900:web:e845955c9c90110edd0e31"
    };

    const firebaseApp = initializeApp(firebaseConfig);
    const db = getFirestore(firebaseApp);

    window.firebaseStore = {
        db,
        collection,
        doc,
        addDoc,
        updateDoc,
        deleteDoc,
        onSnapshot,
        serverTimestamp
    };
    window.dispatchEvent(new Event("firebase-ready"));
    </script>
    <script>
<<<<<<< HEAD
        const { createApp, ref, computed, nextTick } = Vue;
        const myMapEmbedUrl = ref("https://www.google.com/maps/d/embed?mid=16Wj1a1x_1wIqio6fdctKRFKuOGM9b20&hl=zh-TW&ehbc=2E312F");


        createApp({
=======
        const { createApp, ref, computed, onMounted, onBeforeUnmount } = Vue;
        window.addEventListener("firebase-ready", () =>{
            createApp({
>>>>>>> ca70802fa35fff6400f64d902aee809ce6f86a04
            setup() {
                if (!window.firebaseStore) {
                    throw new Error('Firebase 尚未初始化，請確認 SDK 已正確載入');
                }
                const { db, collection, doc, addDoc, updateDoc, deleteDoc, onSnapshot, serverTimestamp } = window.firebaseStore;
                const eventsCollection = collection(db, 'events');
                const spotsCollection = collection(db, 'spots');

                // --- State ---
                const currentTab = ref('itinerary');
                const activeDayIndex = ref(0);
                const showModal = ref(false);
                const showAddToDayModal = ref(false);
                const showAddSpotModal = ref(false);
                const isEditing = ref(false);
                const selectedSpot = ref(null);
                const activeCategory = ref('all');
                const addToDayTime = ref('10:00');
                const addToDayDayIndex = ref(0);

                // Trip Dates
                const days = ref([
                    { date: '12/10', weekday: 'Tue' },
                    { date: '12/11', weekday: 'Wed' },
                    { date: '12/12', weekday: 'Thu' },
                    { date: '12/13', weekday: 'Fri' },
                    { date: '12/14', weekday: 'Sat' },
                    { date: '12/15', weekday: 'Sun' },
                    { date: '12/16', weekday: 'Mon' },
                    { date: '12/17', weekday: 'Tue' },
                ]);

                const events = ref({});
                const spots = ref([]);

                const createEmptyForm = () => ({
                    id: null,
                    title: '',
                    time: '09:00',
                    category: 'sightseeing',
                    location: '',
                    note: '',
                    image: '',
                    dayIndex: activeDayIndex.value
                });
                const form = ref(createEmptyForm());

                const createEmptySpotForm = () => ({
                    name: '',
                    category: 'food',
                    area: '',
                    desc: '',
                    rating: 5.0,
                    image: '',
                    mapsUrl: ''
                });
                const spotForm = ref(createEmptySpotForm());

                // Explore Data
                const categories = [
                    { id: 'all', name: '全部' },
                    { id: 'food', name: '美食' },
                    { id: 'cafe', name: '咖啡' },
                    { id: 'yoga', name: '瑜珈' },
                    { id: 'massage', name: '按摩' },
                ];

                const tabs = [
                    { id: 'itinerary', label: '行程', icon: 'fa-solid fa-calendar-check' },
                    { id: 'explore', label: '探索', icon: 'fa-solid fa-compass' },
                    { id: 'map', label: '足跡', icon: 'fa-solid fa-map' },
                ];

                let eventsUnsubscribe = null;
                let spotsUnsubscribe = null;

                const subscribeToEvents = () => {
                    if (eventsUnsubscribe) eventsUnsubscribe();
                    eventsUnsubscribe = onSnapshot(eventsCollection, (snapshot) => {
                        const grouped = {};
                        snapshot.forEach((docSnap) => {
                            const data = docSnap.data();
                            const dayIndex = typeof data.dayIndex === 'number' ? data.dayIndex : 0;
                            if (!grouped[dayIndex]) grouped[dayIndex] = [];
                            grouped[dayIndex].push({ id: docSnap.id, ...data });
                        });

                        const normalized = {};
                        days.value.forEach((_, idx) => {
                            const dayEvents = grouped[idx] || [];
                            normalized[idx] = dayEvents.sort((a, b) => (a.time || '').localeCompare(b.time || ''));
                        });
                        events.value = normalized;
                    }, (error) => {
                        console.error('載入行程資料失敗', error);
                    });
                };

                const subscribeToSpots = () => {
                    if (spotsUnsubscribe) spotsUnsubscribe();
                    spotsUnsubscribe = onSnapshot(spotsCollection, (snapshot) => {
                        const loaded = [];
                        snapshot.forEach((docSnap) => {
                            const data = docSnap.data();
                            loaded.push({
                                id: docSnap.id,
                                ...data,
                                distance: data.distance || '自訂地點'
                            });
                        });
                        spots.value = loaded.sort((a, b) => (a.name || '').localeCompare(b.name || ''));
                    }, (error) => {
                        console.error('載入探索地點失敗', error);
                    });
                };

                onMounted(() => {
                    subscribeToEvents();
                    subscribeToSpots();
                });

                onBeforeUnmount(() => {
                    if (eventsUnsubscribe) eventsUnsubscribe();
                    if (spotsUnsubscribe) spotsUnsubscribe();
                });

                // --- Computed ---
                const getPageTitle = computed(() => {
                    if (currentTab.value === 'itinerary') return '烏布 !!!';
                    if (currentTab.value === 'explore') return 'JAPA Nearby';
                    if (currentTab.value === 'map') return 'Route Map';
                    return '';
                });

                const currentDayEvents = computed(() => {
                    return events.value[activeDayIndex.value] || [];
                });

                const sortedEvents = computed(() => {
                    return [...currentDayEvents.value].sort((a, b) => a.time.localeCompare(b.time));
                });

                const filteredSpots = computed(() => {
                    if (activeCategory.value === 'all') return spots.value;
                    return spots.value.filter(spot => spot.category === activeCategory.value);
                });

                const nextEvent = computed(() => {
                    if (sortedEvents.value.length > 0) {
                        return sortedEvents.value[0];
                    }
                    return null;
                });

                // --- Methods ---
                const getCategoryIcon = (cat) => {
                    const map = {
                        sightseeing: 'fa-solid fa-camera text-blue-400',
                        food: 'fa-solid fa-utensils text-orange-400',
                        cafe: 'fa-solid fa-mug-hot text-brown-400',
                        yoga: 'fa-solid fa-om text-green-500',
                        massage: 'fa-solid fa-spa text-pink-400',
                        transport: 'fa-solid fa-plane text-slate-400'
                    };
                    return map[cat] || 'fa-solid fa-circle text-slate-300';
                };

                const getCategoryName = (cat) => {
                     const map = {
                        sightseeing: '觀光', food: '美食', cafe: '咖啡', yoga: '瑜珈', massage: '按摩', transport: '交通'
                    };
                    return map[cat] || '一般';
                };

                const getGoogleMapsUrl = (location) => {
                    if (!location) return 'https://www.google.com/maps';
                    if (location.startsWith('http')) return location;
                    return `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(location + ' Ubud Bali')}`;
                };
                
                const openMapLink = (location) => {
                    window.open(getGoogleMapsUrl(location), '_blank');
                };

                // CRUD Events
                const openAddModal = () => {
                    isEditing.value = false;
                    form.value = createEmptyForm();
                    showModal.value = true;
                };

                const editEvent = (event) => {
                    isEditing.value = true;
                    form.value = {
                        ...event,
                        dayIndex: typeof event.dayIndex === 'number' ? event.dayIndex : activeDayIndex.value
                    };
                    showModal.value = true;
                };

                const saveEvent = async () => {
                    const dayIndex = typeof form.value.dayIndex === 'number' ? form.value.dayIndex : activeDayIndex.value;
                    const payload = {
                        title: form.value.title.trim(),
                        time: form.value.time || '09:00',
                        category: form.value.category || 'sightseeing',
                        location: form.value.location.trim(),
                        note: form.value.note.trim(),
                        image: form.value.image || '',
                        dayIndex,
                        updatedAt: serverTimestamp()
                    };

                    try {
                        if (isEditing.value && form.value.id) {
                            await updateDoc(doc(db, 'events', form.value.id), payload);
                        } else {
                            await addDoc(eventsCollection, {
                                ...payload,
                                createdAt: serverTimestamp()
                            });
                        }
                        showModal.value = false;
                        form.value = createEmptyForm();
                    } catch (error) {
                        console.error('儲存行程失敗', error);
                        alert('儲存行程失敗，請稍後再試');
                    }
                };

                const deleteEvent = async (id) => {
                    if (!id) return;
                    if(!confirm('確定要刪除這個行程嗎？')) return;
                    try {
                        await deleteDoc(doc(db, 'events', id));
                    } catch (error) {
                        console.error('刪除行程失敗', error);
                        alert('刪除行程失敗，請稍後再試');
                    }
                };

                // Add Spot Functionality
                const openAddSpotModal = () => {
                    spotForm.value = createEmptySpotForm();
                    showAddSpotModal.value = true;
                };

                const saveNewSpot = async () => {
                    const payload = {
                        name: spotForm.value.name.trim(),
                        category: spotForm.value.category || 'food',
                        area: spotForm.value.area.trim(),
                        desc: spotForm.value.desc.trim(),
                        rating: Number(spotForm.value.rating) || 5,
                        distance: '自訂地點',
                        image: spotForm.value.image || 'https://images.unsplash.com/photo-1537996194471-e657df975ab4?auto=format&fit=crop&q=80&w=400',
                        mapsUrl: spotForm.value.mapsUrl || ''
                    };

                    try {
                        await addDoc(spotsCollection, payload);
                        showAddSpotModal.value = false;
                        activeCategory.value = 'all';
                        spotForm.value = createEmptySpotForm();
                    } catch (error) {
                        console.error('新增探索地點失敗', error);
                        alert('新增探索地點失敗，請稍後再試');
                    }
                };
                // Add from Explore
                const openAddToDayModal = (spot) => {
                    selectedSpot.value = spot;
                    // 預設選到現在行程頁正在看的那一天
                    addToDayDayIndex.value = activeDayIndex.value;
                    // 預設時間，你之後可以改別的
                    addToDayTime.value = '10:00';
                    showAddToDayModal.value = true;
                };


                const confirmAddToDay = async () => {
                    if (!selectedSpot.value) return;
                    const dayIndex = typeof addToDayDayIndex.value === 'number' ? addToDayDayIndex.value : activeDayIndex.value;
                    const payload = {
                        title: selectedSpot.value.name,
                        time: addToDayTime.value || '10:00',
                        category: selectedSpot.value.category || 'sightseeing',
                        location: selectedSpot.value.name,
                        note: 'From Explore',
                        image: selectedSpot.value.image || '',
                        dayIndex,
                        createdAt: serverTimestamp(),
                        updatedAt: serverTimestamp()
                    };

                    try {
                        await addDoc(eventsCollection, payload);
                        showAddToDayModal.value = false;
                        selectedSpot.value = null;
                    } catch (error) {
                        console.error('加入行程失敗', error);
                        alert('加入行程失敗，請稍後再試');
                    }
                };

                return {
                    currentTab,
                    activeDayIndex,
                    days,
                    events,
                    sortedEvents,
                    currentDayEvents,
                    categories,
                    activeCategory,
                    addToDayTime,
                    addToDayDayIndex,
                    filteredSpots,
                    showModal,
                    showAddToDayModal,
                    showAddSpotModal,
                    isEditing,
                    form,
                    spotForm,
                    tabs,
                    getPageTitle,
                    selectedSpot,
                    nextEvent,
                    // methods
                    getCategoryIcon,
                    getCategoryName,
                    getGoogleMapsUrl,
                    openAddModal,
                    editEvent,
                    saveEvent,
                    deleteEvent,
                    openAddSpotModal,
                    saveNewSpot,
                    openAddToDayModal,
                    confirmAddToDay,
                    openMapLink,
<<<<<<< HEAD
                    myMapEmbedUrl,
                    closeModal: () => showModal.value = false
=======
                    closeModal: () => {
                        showModal.value = false;
                        form.value = createEmptyForm();
                    }
>>>>>>> ca70802fa35fff6400f64d902aee809ce6f86a04
                };
            }
        }).mount('#app');
    })
        
    </script>
    <script>
    //if ('serviceWorker' in navigator) {
    //navigator.serviceWorker.register('./service-worker.js');
    //}
    </script>

</body>
</html>
